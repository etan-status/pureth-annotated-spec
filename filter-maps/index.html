
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../log-value-index/">
      
      
        <link rel="next" href="../log-proofs/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Filter maps (EIP-7745) - Pureth</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#filter-maps-eip-7745" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Pureth" class="md-header__button md-logo" aria-label="Pureth" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Pureth
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Filter maps (EIP-7745)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../zh/filter-maps/" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/etan-status/pureth-annotated-spec/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
  
  Pureth

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../implementations-ssz/" class="md-tabs__link">
          
  
  
  SSZ

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../event-logs/" class="md-tabs__link">
          
  
  
  Log reform

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Pureth" class="md-nav__button md-logo" aria-label="Pureth" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Pureth
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/etan-status/pureth-annotated-spec/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pureth
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Pureth
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pureth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meetings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Meeting notes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    SSZ
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            SSZ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../implementations-ssz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Implementations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Log reform
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Log reform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-logs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event logs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logs-bloom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bloom filters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../log-value-index/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Log value index (EIP-7745)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Filter maps (EIP-7745)
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Filter maps (EIP-7745)
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#filter-maps" class="md-nav__link">
    <span class="md-ellipsis">
      Filter maps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter-rows" class="md-nav__link">
    <span class="md-ellipsis">
      Filter rows
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#row-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      Row mapping
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#representation-in-the-data-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Representation in the data structure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../log-proofs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proofs (EIP-7745)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../implementations-7745/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Implementations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#filter-maps" class="md-nav__link">
    <span class="md-ellipsis">
      Filter maps
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filter-rows" class="md-nav__link">
    <span class="md-ellipsis">
      Filter rows
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#row-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      Row mapping
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#representation-in-the-data-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Representation in the data structure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/etan-status/pureth-annotated-spec/edit/main/docs/filter-maps.en.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="filter-maps-eip-7745">Filter maps (EIP-7745)</h1>
<p><a href="https://eips.ethereum.org/EIPS/eip-7745">EIP-7745</a> defines a sequential <a href="../log-value-index/"><em>log value</em> index</a> that enables correctness and completeness proofs for <a href="../event-logs/#eth_getlogs"><code>eth_getLogs</code></a> responses. However, the server would still have to send the entire <em>log value</em> index for the queried range, resulting in gigabytes of data even for the most basic queries. Therefore, <a href="https://eips.ethereum.org/EIPS/eip-7745">EIP-7745</a> further defines the concept of filter maps.</p>
<h2 id="filter-maps">Filter maps</h2>
<p>A filter map can be visualized as a 2D bitmap.</p>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>MAP_WIDTH</code></a>: <span class="arithmatex"><span class="MathJax_Preview">2^{24}</span><script type="math/tex">2^{24}</script></span></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>MAP_HEIGHT</code></a>: <span class="arithmatex"><span class="MathJax_Preview">2^{16}</span><script type="math/tex">2^{16}</script></span></li>
</ul>
<p>For every <a href="../log-value-index/#log-values"><em>log value</em></a> exactly a single bit is set within a filter map. To achieve a bounded false positive rate even at high log frequencies, a new map is initialized periodically.</p>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>VALUES_PER_MAP</code></a>: <span class="arithmatex"><span class="MathJax_Preview">2^{16}</span><script type="math/tex">2^{16}</script></span></li>
</ul>
<p>The filter maps are further grouped into epochs, matching the <a href="../log-value-index/#pruning">pruning</a> mechanism for the <a href="../log-value-index/"><em>log value</em> index</a>. From the type definitions in <a href="https://eips.ethereum.org/EIPS/eip-7745#container-types">EIP-7745</a>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">type</span> <span class="n">FilterRow</span> <span class="o">=</span> <span class="n">ProgressiveByteList</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LogIndexEpoch</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">filter_maps</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Vector</span><span class="p">[</span><span class="n">FilterRow</span><span class="p">,</span> <span class="n">MAPS_PER_EPOCH</span><span class="p">],</span> <span class="n">MAP_HEIGHT</span><span class="p">]</span>
    <span class="n">log_entries</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">LogEntry</span><span class="p">,</span> <span class="n">MAPS_PER_EPOCH</span> <span class="o">*</span> <span class="n">VALUES_PER_MAP</span><span class="p">]</span>
        <span class="c1"># LogEntry containers at the first index of each log event,</span>
        <span class="c1"># default(LogEntry) otherwise</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LogIndex</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">LogIndexEpoch</span><span class="p">,</span> <span class="n">MAX_EPOCH_HISTORY</span><span class="p">]</span>
    <span class="n">next_index</span><span class="p">:</span> <span class="n">uint64</span>  <span class="c1"># next log value index to be added</span>
</code></pre></div>
<h2 id="filter-rows">Filter rows</h2>
<p>Within each of the rows of the filter map, one can visualize that the full <a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>MAP_WIDTH</code></a> is further subdivided into <a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>VALUES_PER_MAP</code></a> groups of 8 bits (1 byte) each. For each <em>log value</em> index, the corresponding bit is set in the corresponding group, i.e., <em>log value</em> index 0 sets a bit within <code>0 ..&lt; 256</code>, <em>log value</em> index 1 sets a bit within <code>256 ..&lt; 512</code>, and so on. Therefore, there cannot be any collisions where a bit is set multiple times.</p>
<p>The <a href="../log-value-index/#log-values"><em>log value</em></a> itself, namely the <code>address</code> or an individual <code>topic</code>, is then used to determine the exact bit position within the group. Vice versa, this means that if a different bit is set than the one pertaining to any given query that the corresponding <a href="../log-value-index/#log-entries">log entry</a> is irrelevant and, hence, does not have to be sent.</p>
<p>Further, the <em>log value index</em> itself is also incorporated into the process to determine the bit position. This avoids repeated false positives when the query bit happens to collide with the bit for a popular event such as the <a href="https://eips.ethereum.org/EIPS/eip-20#events">ERC-20 token transfer</a>.</p>
<p>From the <a href="https://eips.ethereum.org/EIPS/eip-7745#column-mapping">EIP-7745</a> logic:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_column_index</span><span class="p">(</span><span class="n">log_value_index</span><span class="p">,</span> <span class="n">log_value</span><span class="p">):</span>
    <span class="n">log_value_width</span> <span class="o">=</span> <span class="n">MAP_WIDTH</span> <span class="o">//</span> <span class="n">VALUES_PER_MAP</span>                      <span class="c1"># constant</span>
    <span class="n">column_hash</span> <span class="o">=</span> <span class="n">fnv_1a</span><span class="p">(</span><span class="n">to_binary64</span><span class="p">(</span><span class="n">log_value_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_value</span><span class="p">)</span>     <span class="c1"># 64-bit FNV-1A hash</span>
    <span class="n">collision_filter</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">column_hash</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">64</span> <span class="o">//</span> <span class="n">log_value_width</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">column_hash</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">//</span> <span class="n">log_value_width</span><span class="p">)</span>
    <span class="p">)</span> <span class="o">%</span> <span class="n">log_value_width</span>
    <span class="k">return</span> <span class="n">log_value_index</span> <span class="o">%</span> <span class="n">VALUES_PER_MAP</span> <span class="o">*</span> <span class="n">log_value_width</span> <span class="o">+</span> <span class="n">collision_filter</span>
</code></pre></div>
<p>This uses the <a href="https://en.wikipedia.org/wiki/Fowler–Noll–Vo_hash_function#FNV-1a_hash">FNV-1a</a> non-cryptographic hash function, similar to the one used by Python. Further note that the input <code>log_value</code> is <a href="https://eips.ethereum.org/EIPS/eip-7745#updating-the-log-index">additionally hashed</a> with <code>sha2(log_value)</code> before calling <code>get_column_index</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">address_value</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sha2</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">topic_value</span><span class="p">(</span><span class="n">topic</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sha2</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</code></pre></div>
<h2 id="row-mapping">Row mapping</h2>
<p>A filter row spanning <a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>VALUES_PER_MAP</code></a> still uses 64 KB, which is still a lot of data for queries spanning a large number of blocks, especially since it is also required to send for all negative search results (to prove completeness). Therefore, each filter map consists of <a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>MAP_HEIGHT</code></a> filter rows; each <em>log event</em> only sets a bit in one of them.</p>
<p>To enable efficient proving, the row assignment should be somewhat stable: if there are multiple entries matching a query, they should all be in the same row. To avoid the collision problem when a popular event such as the <a href="https://eips.ethereum.org/EIPS/eip-20#events">ERC-20 token transfer</a> is assigned to the same row, a maximum length is also introduced after which the row assignment is changed. The <a href="https://eips.ethereum.org/EIPS/eip-7745#epochs-and-mapping-layers"><em>mapping layer</em> index</a> indicates the number of times that the assignment was changed, and the maximum length increases exponentially on every reassignment until a maximum.</p>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>MAX_BASE_ROW_LENGTH</code></a>: <span class="arithmatex"><span class="MathJax_Preview">2^{3}</span><script type="math/tex">2^{3}</script></span></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7745#proposed-constants"><code>LAYER_COMMON_RATIO</code></a>: <span class="arithmatex"><span class="MathJax_Preview">2^{4}</span><script type="math/tex">2^{4}</script></span></li>
</ul>
<table>
<thead>
<tr>
<th>Layer index</th>
<th>Row capacity</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>MAX_BASE_ROW_LENGTH * LAYER_COMMON_RATIO**0</code> (= <span class="arithmatex"><span class="MathJax_Preview">2^{3}</span><script type="math/tex">2^{3}</script></span>)</td>
</tr>
<tr>
<td>1</td>
<td><code>MAX_BASE_ROW_LENGTH * LAYER_COMMON_RATIO**1</code> (= <span class="arithmatex"><span class="MathJax_Preview">2^7</span><script type="math/tex">2^7</script></span>)</td>
</tr>
<tr>
<td>2+</td>
<td><code>MAX_BASE_ROW_LENGTH * MAPS_PER_EPOCH</code> (= <span class="arithmatex"><span class="MathJax_Preview">2^{10}</span><script type="math/tex">2^{10}</script></span>)</td>
</tr>
</tbody>
</table>
<p>Within a <a href="../log-value-index/#pruning">log epoch</a>, it is further ensured that the row assignment is stable across multiple maps. The initial row assignment (<em>mapping layer</em> 0) for a <em>log value</em> is only changed once per log epoch, while the row assignment at higher <em>mapping layers</em> is changed more frequently, making proofs even more efficient. <a href="https://eips.ethereum.org/EIPS/eip-7745#row-mapping">EIP-7745</a> also contains a diagram that visualizes how the row mapping for a particular <em>log value</em> evolves over time at <em>mapping layers</em> 0, 1, and 2.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_row_index</span><span class="p">(</span><span class="n">map_index</span><span class="p">,</span> <span class="n">log_value</span><span class="p">,</span> <span class="n">layer_index</span><span class="p">):</span>
    <span class="n">layer_factor</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">LAYER_COMMON_RATIO</span> <span class="o">**</span> <span class="n">layer_index</span><span class="p">,</span> <span class="n">MAPS_PER_EPOCH</span><span class="p">)</span>
    <span class="n">row_frequency</span> <span class="o">=</span> <span class="n">MAPS_PER_EPOCH</span> <span class="o">//</span> <span class="n">layer_factor</span>
    <span class="k">return</span> <span class="n">from_binary32</span><span class="p">(</span><span class="n">sha2</span><span class="p">(</span>
        <span class="n">log_value</span> <span class="o">+</span>
        <span class="n">to_binary32</span><span class="p">(</span><span class="n">map_index</span> <span class="o">-</span> <span class="n">map_index</span> <span class="o">%</span> <span class="n">row_frequency</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">to_binary32</span><span class="p">(</span><span class="n">layer_index</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">%</span> <span class="n">MAP_HEIGHT</span>
</code></pre></div>
<p>Note that the input <code>log_value</code> is <a href="https://eips.ethereum.org/EIPS/eip-7745#updating-the-log-index">additionally hashed</a> with <code>sha2(log_value)</code> before calling <code>get_row_index</code>.</p>
<h2 id="representation-in-the-data-structure">Representation in the data structure</h2>
<p>Filter maps are sparse, i.e., they only have a very small number of bits set relative to their full capacity. To represent them more efficiently, each filter row is encoded as the list of column indices for which the bit has been set. Given the grouping from <a href="#filter-rows"><code>get_column_index</code></a>, this means that for each <em>log value</em>, a 24-bit column index is computed, with the top 16 bits indicating the <em>log value</em> index, and the bottom 8 bits indicating the FNV-1a anti-collision hash value. This sequence of 24-bit values is then stored in the log index, in place of the bitmask. From <a href="https://eips.ethereum.org/EIPS/eip-7745#updating-the-log-index">EIP-7745</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Mark a single log value on the filter maps</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_log_value</span><span class="p">(</span><span class="n">log_index</span><span class="p">,</span> <span class="n">log_value</span><span class="p">):</span>
    <span class="n">bytes_per_column</span> <span class="o">=</span> <span class="n">log2</span><span class="p">(</span><span class="n">MAP_WIDTH</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span>   <span class="c1"># assumes that map width is a power of 256</span>

    <span class="n">map_index</span> <span class="o">=</span> <span class="n">log_index</span><span class="o">.</span><span class="n">next_index</span> <span class="o">//</span> <span class="n">VALUES_PER_MAP</span>
    <span class="n">epoch_index</span> <span class="o">=</span> <span class="n">map_index</span> <span class="o">//</span> <span class="n">MAPS_PER_EPOCH</span>
    <span class="n">map_subindex</span> <span class="o">=</span> <span class="n">map_index</span> <span class="o">%</span> <span class="n">MAPS_PER_EPOCH</span>
    <span class="n">column_index</span> <span class="o">=</span> <span class="n">get_column_index</span><span class="p">(</span><span class="n">log_index</span><span class="o">.</span><span class="n">next_index</span><span class="p">,</span> <span class="n">log_value</span><span class="p">)</span>

    <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layer_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">layer_factor</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">LAYER_COMMON_RATIO</span> <span class="o">**</span> <span class="n">layer_index</span><span class="p">,</span> <span class="n">MAPS_PER_EPOCH</span><span class="p">)</span>
        <span class="n">max_row_length</span> <span class="o">=</span> <span class="n">MAX_BASE_ROW_LENGTH</span> <span class="o">*</span> <span class="n">layer_factor</span>
        <span class="n">row_index</span> <span class="o">=</span> <span class="n">get_row_index</span><span class="p">(</span><span class="n">map_index</span><span class="p">,</span> <span class="n">log_value</span><span class="p">,</span> <span class="n">layer_index</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">log_index</span><span class="o">.</span><span class="n">epochs</span><span class="p">[</span><span class="n">epoch_index</span><span class="p">]</span><span class="o">.</span><span class="n">filter_maps</span><span class="p">[</span><span class="n">row_index</span><span class="p">][</span><span class="n">map_subindex</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_row_length</span> <span class="o">*</span> <span class="n">bytes_per_column</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">layer_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">max_row_length</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span>
            <span class="n">max_row_length</span> <span class="o">*</span> <span class="n">LAYER_COMMON_RATIO</span><span class="p">,</span>
            <span class="n">MAX_BASE_ROW_LENGTH</span> <span class="o">*</span> <span class="n">MAPS_PER_EPOCH</span>
        <span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_binary32</span><span class="p">(</span><span class="n">column_index</span><span class="p">)[:</span><span class="n">bytes_per_column</span><span class="p">])</span>

    <span class="n">log_index</span><span class="o">.</span><span class="n">next_index</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
<p>This replaces the <a href="../log-value-index/#updating-the-log-index">stub</a> from the <a href="../log-value-index/"><em>log value</em> index</a> section.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.action.edit", "navigation.expand", "navigation.tabs", "navigation.top"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="../javascripts/mathjax-config.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  </body>
</html>